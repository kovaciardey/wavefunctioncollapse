using System;
using System.Collections;
using System.Collections.Generic;
using System.IO;
using UnityEngine;

/**
 * This class is used to save the data generated by the input processor to a JSON file.
 * It uses an intermediary class to translate the objects from a WfcGenerationData instance into a serializable manner
 */
public class WaveFunctionDataSaver
{
    /**
     * Intermediate class for the WfcGenerationData instance to be properly serialized
     */
    [System.Serializable]
    private class WfcDataWrapper
    {
        public int totalPixels;
        public List<string> tileHashes = new List<string>();
        public List<TileEntry> tileMap = new List<TileEntry>();
        public List<TileCount> tileCounts = new List<TileCount>();
        public List<TileWeight> tileWeights = new List<TileWeight>();
        public List<TileNeighbor> tileNeighbors = new List<TileNeighbor>();
        public List<TileNeighborAlternate> tileNeighborsAlternate = new List<TileNeighborAlternate>();
        
        // TODO: perhaps make all these a single TileData class as they all have the same key 
        [System.Serializable]
        public class TileEntry
        {
            public string tileUniqueString;
            public string colorValue;
        }
        
        [System.Serializable]
        public class TileCount
        {
            public string tileUniqueString;
            public int occurrences;
        }
        
        [System.Serializable]
        public class TileWeight
        {
            public string tileUniqueString;
            public float weight;
        }
        
        [System.Serializable]
        public class TileNeighbor
        {
            public string tileUniqueString;
            public string neighborUniqueString;
            public string direction;
        }
        
        [System.Serializable]
        public class TileDirectionNeighbors
        {
            public string direction;
            public List<string> neighbors;
        }
        
        [System.Serializable]
        public class TileNeighborAlternate
        {
            public string tileUniqueString;
            public List<TileDirectionNeighbors> directionNeighborsList;
        }

        public WfcDataWrapper(WfcGenerationData data)
        {
            totalPixels = data.TotalPixels;

            foreach (string tileHash in data.TileHashes)
            {
                tileHashes.Add(tileHash);
            }
            
            foreach (KeyValuePair<string, Color> kvp in data.TileMap)
            {
                tileMap.Add(new TileEntry
                {
                    tileUniqueString = kvp.Key, 
                    colorValue = CustomUtils.ColorToHex(kvp.Value)
                });
            }

            foreach (KeyValuePair<string, int> kvp in data.TileCounts)
            {
                tileCounts.Add(new TileCount
                {
                    tileUniqueString = kvp.Key,
                    occurrences = kvp.Value
                });
            }

            foreach (KeyValuePair<string, float> kvp in data.TileWeights)
            {
                tileWeights.Add(new TileWeight
                {
                    tileUniqueString = kvp.Key,
                    weight = kvp.Value
                });   
            }

            foreach (Tuple<string,string,string> pair in data.TileNeighbors)
            {
                tileNeighbors.Add(new TileNeighbor
                {
                    tileUniqueString = pair.Item1,
                    neighborUniqueString = pair.Item2,
                    direction = pair.Item3
                });
            }

            foreach (KeyValuePair<string, Dictionary<string, List<string>>> kvp in data.TileNeighborsAlternate)
            {
                TileNeighborAlternate tileNeighborAlt = new TileNeighborAlternate
                {
                    tileUniqueString = kvp.Key,
                    directionNeighborsList = new List<TileDirectionNeighbors>()
                };

                foreach (KeyValuePair<string,List<string>> variable in kvp.Value)
                {
                    TileDirectionNeighbors tileDirectionNeighbors = new TileDirectionNeighbors
                    {
                        direction = variable.Key,
                        neighbors = variable.Value
                    };
                    
                    tileNeighborAlt.directionNeighborsList.Add(tileDirectionNeighbors);
                }
                
                tileNeighborsAlternate.Add(tileNeighborAlt);
            }
        }
    }
    
    /**
     * Save the serialized WfcGenerationData to a JSON file named the same as the input image
     */
    public static void SaveToJson(WfcGenerationData data, string fileName)
    {
        string json = JsonUtility.ToJson(new WfcDataWrapper(data), true); // Pretty print

        string path = Path.Combine(Application.dataPath, "Resources", fileName + ".json");

        File.WriteAllText(path, json);
        Debug.Log("Saved JSON to: " + path);
    }
    
    /**
     * Load a JSON file and create nad return a WfcGenerationData instance
     */
    // TODO: this is just here for later. it is not being used at the moment
    public static WfcGenerationData LoadFromJson(string fileName)
    {
        TextAsset jsonFile = Resources.Load<TextAsset>(fileName);
        if (jsonFile == null)
        {
            Debug.LogError("File not found: " + fileName);
            return null;
        }
        
        // TODO: Would be good to have a separate function for translating each object back into the appropriate WfcDataGeneration object
        WfcDataWrapper wrapper = JsonUtility.FromJson<WfcDataWrapper>(jsonFile.text);
        var data = new WfcGenerationData
        {
            TotalPixels = wrapper.totalPixels,
            TileMap = new Dictionary<string, Color>()
        };

        foreach (var entry in wrapper.tileMap)
        {
            // TODO: call the utils function to convert the hex string back into a color class
            // data.TileMap[entry.tileUniqueString] = entry.colorValue;
        }

        return data;
    }
}